<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ module_title }} - Chat Interface</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- DOMPurify for safe HTML -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        /* Markdown content styling */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1 { @apply text-2xl font-bold mt-4 mb-2; }
        .markdown-content h2 { @apply text-xl font-bold mt-3 mb-2; }
        .markdown-content h3 { @apply text-lg font-bold mt-2 mb-1; }
        .markdown-content p { @apply mb-3; }
        .markdown-content ul { @apply list-disc list-inside mb-3 ml-4; }
        .markdown-content ol { @apply list-decimal list-inside mb-3 ml-4; }
        .markdown-content blockquote { @apply border-l-4 border-gray-300 pl-4 italic my-3; }
        .markdown-content code:not([class*="language-"]) {
            @apply bg-gray-100 px-1 py-0.5 rounded text-sm font-mono;
        }
        .markdown-content pre { @apply rounded-lg my-3 overflow-x-auto; }
        .markdown-content table { @apply w-full border-collapse my-3; }
        .markdown-content th { @apply border border-gray-300 px-3 py-2 bg-gray-100; }
        .markdown-content td { @apply border border-gray-300 px-3 py-2; }
        .markdown-content a { @apply text-blue-600 hover:text-blue-800 underline; }
        .markdown-content hr { @apply my-4 border-gray-300; }

        /* Image styling */
        .markdown-content img {
            @apply max-w-full h-auto rounded-lg shadow-md my-3;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .markdown-content p img {
            @apply inline-block mx-1;
        }
        .markdown-content figure {
            @apply my-4 text-center;
        }
        .markdown-content figcaption {
            @apply text-sm text-gray-600 mt-2 italic;
        }

        /* Math styling */
        .math-display {
            @apply my-4 text-center overflow-x-auto;
        }
        .math-inline {
            @apply inline-block mx-1;
        }

        /* User message markdown styling - light text on gradient background */
        .user-message h1,
        .user-message h2,
        .user-message h3,
        .user-message h4,
        .user-message h5,
        .user-message h6 {
            @apply text-white font-bold;
        }
        .user-message p {
            @apply text-white mb-2;
        }
        .user-message ul,
        .user-message ol {
            @apply text-white;
        }
        .user-message code:not([class*="language-"]) {
            @apply bg-white bg-opacity-20 text-white px-1 py-0.5 rounded;
        }
        .user-message pre {
            @apply bg-white bg-opacity-10 text-white rounded-lg p-3 my-2;
        }
        .user-message a {
            @apply text-white underline hover:text-gray-200;
        }
        .user-message blockquote {
            @apply border-l-4 border-white border-opacity-50 pl-4 text-white italic;
        }
        .user-message hr {
            @apply border-white border-opacity-30;
        }

        /* Loading animation */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }
        .typing-indicator span {
            height: 10px;
            width: 10px;
            background-color: #9CA3AF;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="h-screen flex flex-col px-2 sm:px-4 md:px-8">
        <!-- Header -->
        <div class="bg-white sm:rounded-t-2xl shadow-lg px-3 sm:px-6 py-3 sm:py-4 border-b">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div class="flex-1">
                    <h1 class="text-lg sm:text-2xl font-bold text-gray-800">{{ workflow_name }}</h1>
                    <p class="text-xs sm:text-sm text-gray-500">{{ workflow_description }}</p>
                </div>
                <div class="flex items-center gap-2 sm:gap-3">
                    <button
                        onclick="clearChat()"
                        class="px-2 sm:px-4 py-1 sm:py-2 text-xs sm:text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors"
                    >
                        <span class="hidden sm:inline">Clear Chat</span>
                        <span class="sm:hidden">Clear</span>
                    </button>
                    <div class="flex items-center gap-1 sm:gap-2">
                        <div class="w-2 h-2 sm:w-3 sm:h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs sm:text-sm text-gray-600">Online</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages Container -->
        <div class="bg-white flex-1 overflow-hidden shadow-lg">
            <div
                id="chat-messages"
                class="h-full overflow-y-auto custom-scrollbar p-3 sm:p-4 md:p-6 space-y-3 sm:space-y-4"
            >
                <!-- Welcome message -->
                <div class="flex items-start gap-2 sm:gap-3">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs sm:text-sm font-bold flex-shrink-0">
                        W
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-500 mb-1">Workflow Assistant</div>
                        <div class="bg-gray-100 rounded-xl sm:rounded-2xl rounded-tl-none px-3 sm:px-4 py-2 sm:py-3 max-w-full sm:max-w-3xl">
                            <div class="markdown-content">
                                Welcome! I'm ready to help you. Send me a message to get started.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white sm:rounded-b-2xl shadow-lg px-3 sm:px-6 py-3 sm:py-4 border-t">
            <form
                id="chat-form"
                hx-post="{{ chat_api_prefix }}/chat/send"
                hx-target="#chat-messages"
                hx-swap="beforeend"
                hx-on:htmx:before-request="addUserMessageAndLoading(event)"
                hx-on:htmx:after-request="enableFormElements(); document.getElementById('message-input').focus()"
                hx-on:htmx:response-error="handleError(event)"
                class="flex gap-2 sm:gap-3"
            >
                <input
                    type="hidden"
                    id="session-id"
                    name="session_id"
                    value="{{ session_id }}"
                />
                <textarea
                    id="message-input"
                    name="message"
                    placeholder="Type your message..."
                    class="flex-1 px-3 sm:px-4 py-2 sm:py-3 border border-gray-200 rounded-lg sm:rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm sm:text-base"
                    required
                    autocomplete="off"
                    rows="1"
                    style="min-height: 48px; max-height: 120px;"
                ></textarea>
                <button
                    type="submit"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg sm:rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all transform focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        // Configure marked options
        marked.setOptions({
            highlight: function(code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                }
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Function to render markdown content safely
        function renderMarkdown(content) {
            // Store math expressions and replace with placeholders
            const mathExpressions = [];
            let mathCounter = 0;

            // Replace display math $$...$$ first
            content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                const id = mathCounter++;
                mathExpressions.push({ id, type: 'display', content: math.trim() });
                return `MATH_PLACEHOLDER_${id}`;
            });

            // Replace inline math $...$
            content = content.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                const id = mathCounter++;
                mathExpressions.push({ id, type: 'inline', content: math.trim() });
                return `MATH_PLACEHOLDER_${id}`;
            });

            // Replace LaTeX display math \[...\]
            content = content.replace(/\\\[([\s\S]*?)\\\]/g, (match, math) => {
                const id = mathCounter++;
                mathExpressions.push({ id, type: 'display', content: math.trim() });
                return `MATH_PLACEHOLDER_${id}`;
            });

            // Replace LaTeX inline math \(...\)
            content = content.replace(/\\\((.*?)\\\)/g, (match, math) => {
                const id = mathCounter++;
                mathExpressions.push({ id, type: 'inline', content: math.trim() });
                return `MATH_PLACEHOLDER_${id}`;
            });

            // Parse markdown
            let html = marked.parse(content);

            // Restore math expressions
            mathExpressions.forEach(({ id, type, content }) => {
                const placeholder = `MATH_PLACEHOLDER_${id}`;
                const mathHtml = type === 'display'
                    ? `<div class="math-display">$$${content}$$</div>`
                    : `<span class="math-inline">$${content}$</span>`;

                // Replace all occurrences (in case markdown wrapped it)
                html = html.split(placeholder).join(mathHtml);
            });

            // Sanitize HTML while preserving our math elements
            const cleanHtml = DOMPurify.sanitize(html, {
                ADD_TAGS: ['figure', 'figcaption'],
                ADD_ATTR: ['target', 'rel', 'class'],
                ALLOW_DATA_ATTR: true,
                ADD_DATA_URI_TAGS: ['img'],
                ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|data):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i
            });

            return cleanHtml;
        }

        // Apply markdown rendering to all elements with markdown-content class
        function processMarkdownElements() {
            document.querySelectorAll('.markdown-raw').forEach(el => {
                const content = el.textContent;
                el.innerHTML = renderMarkdown(content);
                el.classList.remove('markdown-raw');
                el.classList.add('markdown-content');

                // Re-highlight code blocks
                el.querySelectorAll('pre code').forEach((block) => {
                    Prism.highlightElement(block);
                });

                // Render math elements with KaTeX
                // Process display math
                el.querySelectorAll('.math-display').forEach((mathEl) => {
                    const mathContent = mathEl.textContent.replace(/^\$\$/, '').replace(/\$\$$/, '');
                    try {
                        katex.render(mathContent, mathEl, {
                            displayMode: true,
                            throwOnError: false
                        });
                    } catch (e) {
                        console.error('KaTeX error:', e);
                        mathEl.innerHTML = `<span style="color: red;">Math error: ${escapeHtml(mathContent)}</span>`;
                    }
                });

                // Process inline math
                el.querySelectorAll('.math-inline').forEach((mathEl) => {
                    const mathContent = mathEl.textContent.replace(/^\$/, '').replace(/\$$/, '');
                    try {
                        katex.render(mathContent, mathEl, {
                            displayMode: false,
                            throwOnError: false
                        });
                    } catch (e) {
                        console.error('KaTeX error:', e);
                        mathEl.innerHTML = `<span style="color: red;">Math error: ${escapeHtml(mathContent)}</span>`;
                    }
                });

                // Add error handling and lazy loading for images
                el.querySelectorAll('img').forEach((img) => {
                    // Add lazy loading
                    img.loading = 'lazy';

                    // Add error handling
                    img.onerror = function() {
                        this.onerror = null;
                        this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"%3E%3Crect width="200" height="200" fill="%23f3f4f6"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%239ca3af" font-family="system-ui" font-size="14"%3EImage not found%3C/text%3E%3C/svg%3E';
                        this.alt = this.alt || 'Image not found';
                        this.classList.add('opacity-50');
                    };

                    // Add click handler for full-screen view
                    img.style.cursor = 'pointer';
                    img.onclick = function() {
                        // Create modal for full-screen image view
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-90 p-4';
                        modal.onclick = function() { modal.remove(); };

                        const fullImg = document.createElement('img');
                        fullImg.src = this.src;
                        fullImg.className = 'max-w-full max-h-full object-contain';

                        modal.appendChild(fullImg);
                        document.body.appendChild(modal);
                    };
                });
            });
        }

        // Add user message and loading indicator before sending request
        function addUserMessageAndLoading(event) {
            const messageInput = document.getElementById('message-input');
            const submitButton = document.querySelector('button[type="submit"]');
            const message = messageInput.value.trim();

            if (!message) return;

            // Clear input immediately and disable form elements
            messageInput.value = '';
            messageInput.style.height = '48px'; // Reset height
            messageInput.disabled = true;
            submitButton.disabled = true;

            // Add visual feedback to disabled elements
            messageInput.classList.add('opacity-50', 'cursor-not-allowed');
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Generate unique message ID
            const messageId = 'msg_' + Math.random().toString(36).substr(2, 9);

            // Store message ID for the response to use
            event.detail.xhr.setRequestHeader('X-Message-ID', messageId);

            // Render user message with markdown
            const renderedMessage = renderMarkdown(message);

            // Create user message HTML with markdown content
            const userMessageHTML = `
                <div class="flex items-start gap-2 sm:gap-3 justify-end">
                    <div class="flex-1 flex flex-col items-end min-w-0">
                        <div class="text-xs text-gray-500 mb-1">You</div>
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl sm:rounded-2xl rounded-tr-none px-3 sm:px-4 py-2 sm:py-3 max-w-full sm:max-w-3xl">
                            <div class="text-white markdown-content user-message">
                                ${renderedMessage}
                            </div>
                        </div>
                    </div>
                    <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-700 text-xs sm:text-sm font-bold flex-shrink-0">
                        U
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="loading-${messageId}" class="flex items-start gap-2 sm:gap-3">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs sm:text-sm font-bold flex-shrink-0">
                        W
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-500 mb-1">Workflow Assistant</div>
                        <div class="bg-gray-100 rounded-xl sm:rounded-2xl rounded-tl-none px-3 sm:px-4 py-2 sm:py-3 max-w-full sm:max-w-3xl">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add to chat immediately
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.insertAdjacentHTML('beforeend', userMessageHTML);

            // Process math in user message
            const userMessageEl = chatMessages.lastElementChild.previousElementSibling;
            if (userMessageEl) {
                const mathElements = userMessageEl.querySelectorAll('.math-display, .math-inline');
                mathElements.forEach(el => {
                    const isDisplay = el.classList.contains('math-display');
                    const mathContent = el.textContent.replace(/^\$\$?/, '').replace(/\$?\$$/, '');
                    try {
                        katex.render(mathContent, el, {
                            displayMode: isDisplay,
                            throwOnError: false
                        });
                    } catch (e) {
                        console.error('KaTeX error in user message:', e);
                    }
                });
            }

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Re-enable form elements after response
        function enableFormElements() {
            const messageInput = document.getElementById('message-input');
            const submitButton = document.querySelector('button[type="submit"]');

            // Re-enable form elements
            messageInput.disabled = false;
            submitButton.disabled = false;

            // Remove visual feedback
            messageInput.classList.remove('opacity-50', 'cursor-not-allowed');
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // Handle error responses
        function handleError(event) {
            enableFormElements();

            // Find the last loading indicator and replace with error message
            const loadingIndicators = document.querySelectorAll('[id^="loading-"]');
            const lastLoading = loadingIndicators[loadingIndicators.length - 1];

            if (lastLoading) {
                lastLoading.innerHTML = `
                    <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-red-500 flex items-center justify-center text-white text-xs sm:text-sm font-bold flex-shrink-0">
                        !
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs text-gray-500 mb-1">Error</div>
                        <div class="bg-red-50 border border-red-200 rounded-xl sm:rounded-2xl rounded-tl-none px-3 sm:px-4 py-2 sm:py-3 max-w-full sm:max-w-3xl">
                            <div class="text-red-700">
                                Sorry, I encountered an error processing your request. Please try again.
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Clear chat function
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                document.getElementById('chat-messages').innerHTML = `
                    <div class="flex items-start gap-2 sm:gap-3">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs sm:text-sm font-bold flex-shrink-0">
                            W
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-gray-500 mb-1">Workflow Assistant</div>
                            <div class="bg-gray-100 rounded-xl sm:rounded-2xl rounded-tl-none px-3 sm:px-4 py-2 sm:py-3 max-w-full sm:max-w-3xl">
                                <div class="markdown-content">
                                    Chat cleared. Send me a message to start a new conversation.
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // Generate new session ID
                document.getElementById('session-id').value = 'session_' + Date.now();
            }
        }

        // Process markdown after HTMX swaps content
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Small delay to ensure DOM is ready
            setTimeout(function() {
                processMarkdownElements();
                // Scroll to bottom
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }, 10);
        });

        // Also listen for afterSettle event as backup
        document.body.addEventListener('htmx:afterSettle', function(event) {
            processMarkdownElements();
        });

        // Initial processing
        processMarkdownElements();

        // Auto-resize textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = '48px';
            const scrollHeight = textarea.scrollHeight;
            const maxHeight = 120;
            if (scrollHeight > 48) {
                textarea.style.height = Math.min(scrollHeight, maxHeight) + 'px';
            }
        }

        // Handle Enter vs Shift+Enter
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const form = document.getElementById('chat-form');
                if (this.value.trim()) {
                    form.requestSubmit();
                }
            }
        });

        // Auto-resize on input
        messageInput.addEventListener('input', function() {
            autoResizeTextarea(this);
        });

        // Focus on input on load
        messageInput.focus();
    </script>
</body>
</html>
